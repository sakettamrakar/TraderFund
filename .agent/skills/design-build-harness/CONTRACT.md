# Design/Build Execution Harness: Service Contract

**Status**: Constitutional â€” Binding  
**Scope**: Meta-Engineering Orchestration  
**Authority**: This contract defines the procedural and safety requirements for the `design-build-harness` skill.

---

## 1. Execution Flow Definition

The harness operates in a strict, deterministic loop. Every cycle must follow these seven steps:

### Step 1: Task Graph Ingestion
- Read `docs/epistemic/roadmap/task_graph.md`.
- Extract all tasks and identify those with status `ACTIVE`.
- Map tasks to [DWBS.md](file:///c:/GIT/TraderFund/docs/architecture/DWBS.md) items.

### Step 2: Dependency & Selector Resolution
- Construct the task DAG.
- Apply the **Execution Selector** (all, range, list, first_n, last_n).
- Filter out tasks whose predecessors are not `SUCCESS` or `SYNCED`.
- Verify the current Plane gate is open.

### Step 3: Precondition Checks
- For each selected task, verify:
    - **Inputs Exist**: All required documents/artifacts are present.
    - **Validated**: The `drift-detector` must report `PASS` or `SYNCED`.
    - **No Redundancy**: If `Artifacts` already exist and match their expected state, mark as `SYNCED` and skip execution.

### Step 4: Validator Invocation (Pre-Execution)
- Run `scripts/epistemic_validator.py`.
- If any `FAIL` or `CRITICAL` severity is triggered, **HALT** immediately.

### Step 5: Task Execution & DID Generation
- Invoke the designated skill for the task.
- If the task declares `Impacts`, automatically generate a **Documentation Impact Declaration (DID)** in `docs/impact/`.
- Capture produced `Artifacts` and verify their hashes.

### Step 6: Post-Execution Hooks
- For each successful task, invoke the skills listed in `Post Hooks` in order.
- Standard hooks: `evolution-recorder` (log), `drift-detector` (verify post-state).
- Hook failures halt the cycle but do not revert the task success.

### Step 7: Ledger Write & Status Sync
- On task completion, write a deterministic entry to `evolution_log.md`.
- Update the `task_graph.md` status to `SUCCESS` or `FAILED`.
- Finalize the audit record for the cycle.

---

## 2. Ledger & DID Interaction Contract

### Entry Types
| Entry Type | Target File | Purpose |
|:-----------|:------------|:--------|
| **Task Success** | `evolution_log.md` | Permanent record of artifact production. |
| **DID Creation** | `docs/impact/` | Declaration of documentation debt. |
| **Gate Completion** | `decisions.md` | Authorization to proceed to the next Plane. |

### Task Entry Schema
Each result must record:
- `task_id`, `status`, `duration_ms`.
- `artifacts`: List of `(path, hash)`.
- `impacted_docs`: List of DIDs generated.
- `validator_state`: `PASS` or `FAIL` (with report hash).

### DID Schema Alignment
DIDs generated by the harness must follow the `docs/epistemic/documentation_contract.md` standard:
- **Change Summary**: Derived from Task Purpose.
- **Change Type**: Derived from Task Type.
- **Impacted Documents**: Derived from Task `Impacts` field.

---

## 3. Failure & Safety Semantics

### Violation Handling
- **Validation Failure**: HALT. Proceeding with a failed validator is an architectural breach.
- **Orphan Artifacts**: If the harness finds artifacts not declared in the task graph, it triggers a `CD-1` (Structural Drift) warning.

### Idempotency
- If the harness is re-run on a range where tasks are already `SUCCESS`, it must perform a **Verification Check** only. No new DIDs or Ledger entries are produced if state is consistent.

---

## 4. Change Log

### [2026-01-24] v2.0: Selector & Hook Support
- **Refinement**: Upgraded to support granular execution control and standardized post-hooks.
- **Rationale**: Support for partial execution and automated DID generation.
- **Risk Prevented**: Prevents manual documentation omission and unsafe execution of unvalidated states.
